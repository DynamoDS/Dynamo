<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

  <Product Id="{28362521-26E2-4E78-BFCF-BB0D1E8F5C2A}"
           Name="$(var.DynPdtName)"
           Language="1033"
           Version="$(var.DynVer).$(var.DynRev)"
           Manufacturer="Dynamo"
           UpgradeCode="{EFF4EBAD-E976-4EA8-A110-537D6D0B669A}">

    <Package InstallerVersion="200"
             Compressed="yes"
             InstallScope="perMachine"
             Platform="x64"/>

    <MajorUpgrade
      Schedule="afterInstallInitialize"
      DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

    <MediaTemplate EmbedCab="yes" />

    <Binary Id="DynamoInstallActions.CA.dll"
            src="$(var.base)\src\DynamoInstallActions\bin\$(var.Configuration)\DynamoInstallActions.CA.dll" />

    <CustomAction Id="UninstallDynamo07"
                Return="check"
                Execute="immediate"
                BinaryKey="DynamoInstallActions.CA.dll"
                DllEntry="UninstallDynamo07" >
    </CustomAction>

    <InstallExecuteSequence>
      <Custom Action="UninstallDynamo07" Before="CostInitialize">NOT Installed</Custom>
    </InstallExecuteSequence>

    <Property Id='ARPNOMODIFY'>1</Property>
    
    <!--<UIRef Id="WixUI_FeatureTree"/>
    <WixVariable Id="WixUILicenseRtf" Value="$(env.DYNAMO_BASE)\doc\distrib\License.rtf"/>-->

    <Property Id='DYNAMO_INSTALLDIR'></Property>
    <SetProperty Id="DYNAMO_INSTALLDIR" Value="[ProgramFiles64Folder]\Dynamo" After="LaunchConditions"></SetProperty>

    <Feature Id="DYNAMO_CORE_FEATURE"
             Title="Dynamo Core"
             Level="1">
      <ComponentGroupRef Id="RELEASE"/>
      <ComponentGroupRef Id="DEFINITIONS"/>
      <ComponentRef Id="ApplicationShortcut" />
      <Feature Id="DYNAMO_CORE_SAMPLES"
             Title="Sample Content"
             Level="1" >
        <ComponentGroupRef Id="SAMPLES"/>
      </Feature>
    </Feature>

    <Icon Id="DynamoInstaller.ico" SourceFile="$(var.base)\tools\install\Extra\DynamoInstaller.ico"/>
    <Property Id="ARPPRODUCTICON" Value="DynamoInstaller.ico" />

  </Product>

  <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="Dynamo"/>
      </Directory>
      <Directory Id="DYNAMO_INSTALLDIR"/>
      <Directory Id="CommonAppDataFolder">
        <Directory Id="ADESK_DATA" Name="Autodesk">
        </Directory>
        <Directory Id="DYNAMO_PROGDATA" Name="Dynamo">
          <Directory Id="PROGDATA" Name="$(var.DynVer)"/>
        </Directory>
      </Directory>
    </Directory>

    <!-- Install a shortcut in the Start menu -->
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcut" Guid="d7575401-f8ba-488f-b5e4-5ad24dbc4b10" Win64="yes">
        <Shortcut Id="ApplicationStartMenuShortcut"
                  Name="Dynamo"
                  Description="Dynamo Sandbox"
                  Target="[DYNAMO_INSTALLDIR]\DynamoSandbox.exe"
                  WorkingDirectory="DYNAMO_INSTALLDIR"/>
        <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall"/>
        <RegistryValue Root="HKCU" Key="Software\Dynamo\$(var.DynVer)" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
        <RegistryKey Root="HKLM"
                     Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\[ProductName]"
              Action="createAndRemoveOnUninstall">
          <RegistryValue Name="InstallLocation" Value="[DYNAMO_INSTALLDIR]" Type="string" />
          <RegistryValue Name="DisplayName" Value="[ProductName]" Type="string"/>
          <RegistryValue Name="DisplayVersion" Value="[ProductVersion]" Type="string"/>
        </RegistryKey>
        
      </Component>
    </DirectoryRef>
  </Fragment>
  
</Wix>
